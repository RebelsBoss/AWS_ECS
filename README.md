**Початкове знайомство з AWS ECS.**

# 1. **Створити VPC, subnet, igw, route table та security groups.**

Вибираємо необхідний нам регіон. Заходимо до [VPC](https://eu-central-1.console.aws.amazon.com/vpcconsole/home?region=eu-central-1#Home:). Та створюємо мережу, підмережі, доступ до інтернету та все прописуємо у маршрутах.  
Вибираємо **“VPC only”** друга опція має переваги, але вона коштує додаткових грошей. Також пишемо наш **CIDR** для мережі.

![Screenshot 2024-09-17 163322](https://github.com/user-attachments/assets/4e598219-3e5d-4962-b2c3-54959ad7cd30)

Обираємо мережу, та [додаємо підмережі](https://eu-central-1.console.aws.amazon.com/vpcconsole/home?region=eu-central-1#subnets:). Прописуємо **CIDR** для кожної.

![Screenshot 2024-09-17 163336](https://github.com/user-attachments/assets/059d9120-f18b-4ce6-8407-71dc0a6c4ead)

![Screenshot 2024-09-17 163739](https://github.com/user-attachments/assets/cab44203-acf9-48ea-bedc-029110b577bd)

Надаємо доступ до інтернету з наших підмереж створивши [**igw**](https://eu-central-1.console.aws.amazon.com/vpcconsole/home?region=eu-central-1#igws:).

![Screenshot 2024-09-17 163348](https://github.com/user-attachments/assets/44fb6ef2-cf7f-4769-9e9f-1caa6f243543)

Тепер треба написати маршрути у [**route table**](https://eu-central-1.console.aws.amazon.com/vpcconsole/home?region=eu-central-1#RouteTables:) для **igw,** щоб наші ресурси мали доступ до інтернету та був доступ до них через інтернет.

![Screenshot 2024-09-17 171650](https://github.com/user-attachments/assets/c5b29e10-3baf-48a3-a2b4-33ae6a4e2b31)


Також для того, щоб зробити публічною **endpoint** нашої **RDS** маємо поставити галочку **Enable DNS hostnames**. 

![][image7]  
**![][image8]**  
**![][image9]**

Створюємо [**security groups**](https://eu-central-1.console.aws.amazon.com/vpcconsole/home?region=eu-central-1#SecurityGroups:) та відкриваємо необхідні порти.

![][image10]

# 2. **Створити RDS**

Заходимо до [**RDS**](https://eu-central-1.console.aws.amazon.com/rds/home?region=eu-central-1) та створюємо нову базу.  
Вибираємо **“Standard create”,** друга опція легша але не буде повний перелік всіх можливостей. Вибираємо необхідну нам базу, версію та середу(прод, дев, тест).

![][image11]  
![][image12]

Прописуємо назву нашого інстансу. Маємо дві опції для логіну або через **Secrets Manager**, що є бест практиками. Або **Self managed** де ми самі пишемо юзера та пароль під якими будемо заходити до нашої бази.   
	Після чого вибираємо тип нашого інстансу з необхідними нам ресурсами.  
![][image13]  
![][image14]  
Обираємо розмір сховища, його тип (**ssd/hdd**), **iops**, встановлюємо поріг для скейлингу.

![][image15]

По проекту ми не створюємо другу **read replica**. По бест практикам рекомендуємо мати такий дубль інстансу.

![][image16]

Обираємо нашу створену **VPC**, тип підключення та надаємо публічний доступ до бази. По бест практикам рекомендуємо таки базу не робити публічною та створювати для неї окремі приватні підмережі.

![][image17]

Далі знаходимо нашу **security group**, яку створювали на початку. Рекомендуємо також для бази робити окрему. Налаштовуємо теги, та варіанти аутентифікації. Ми обирали **Password authentication**.  
Рекомендуємо вмикати моніторинг ти налаштовувати бекапування для відстежування логів майже у реальному часі і для відмовостійкості і надійності збереження даних робити бекапи.

![][image18]  
![][image19]

![][image20]

# 3. **Створити AWS ECS cluster**

Заходимо до [AWS ECS](https://eu-central-1.console.aws.amazon.com/ecs/v2/clusters?region=eu-central-1) та створюємо кластер.  
Пишемо назву для нового кластеру та обираємо інфраструктуру на якій будуть працювати наші контейнери.

![][image21]

По дефолту стоїть **АМІ Amazon Linux 2 (kernel 5.10)**, рекомендуємо обирати **Amazon Linux 2**. Був момент у підключені для серверу через веб, на дефолтному **АМІ** це не вдається.

![][image22]

Вибираємо нашу **VPC** та підмережі у яких будуть знаходитись інстанси, нашу створену **security group** та по проекту додавали публічну ІР адресу. Рекомендуємо вмикати моніторинг.

![][image23]

# 4.  **Створити [task definitions](https://eu-central-1.console.aws.amazon.com/ecs/v2/task-definitions?region=eu-central-1)**.

Обираємо інфраструктуру на якій будуть хоститься контейнери, у нашому випадку це **ЕС2**. Також дуже важливо обрати мережевий мод для таску, у нашому варіанті можемо залишити дефолтний мод.

**![][image24]**

Далі пишемо ім’я контейнера та шлях до іміджу. Якщо **ECS** не знайде імідж локально тоді буде шукати у **dockerhub**. Робимо порт форвардінг, по дефолту на хост порті буде 0, це рандомно надасть порт.

**![][image25]**

Таски мають своє версіонування, з кожної версії можна створити нову.

![][image26]

# 5. **Створити [target group](https://eu-central-1.console.aws.amazon.com/ec2/home?region=eu-central-1#TargetGroups:)**

Тепер створюємо таргет групу у яку будемо додавати сервіс **ECS**. Для сервісу на **ЕС2** вибираємо інстанс. Якщо буде **Fargate** тоді ІР адресу.

![][image27]

Дуже важливо для health check вказати саме шлях до нашої першої сторінки.

![][image28]

# 6. **Створити [Load Balancer](https://eu-central-1.console.aws.amazon.com/ec2/home?region=eu-central-1#LoadBalancers:)**

Тепер створюємо **Load Balancer** для нашого додатку. На першій сторінці маємо декілька варіантів, ми рекомендуємо саме **Application Load Balancer**.

![][image29]

Пишемо ім’я, та робимо балансер публічним.

![][image30]

Обираємо мережу та зони які **Load Balancer** буде обслуговувати, **security group** яку створили раніше, а також прописуємо **listeners** які буде слухати наш балансир.

![][image31]![][image32]  
![][image33]

# 7. **Створити AWS [ECS](https://eu-central-1.console.aws.amazon.com/ecs/v2/clusters?region=eu-central-1) service з доданим Load Balancer**

Бест практики розгортання контейнерів у кластері ECS, це розгортання саме на сервісах. Сервіси це сутність яка керує нашими тасками і контейнерами всередині. У сервісах безліч опцій та можливостей, наприклад автоскейлинг, лоад балансер, балансування контейнерів між серверами та багато іншого.  
Вибираємо сервіс, таск яким він буде керувати, бажану кількість реплік.

![][image34]  
![][image35]

Відкриваємо вкладку балансира та вибираємо створений нами раніше балансир. Обираємо **listeners**, **target groups** та обов’язково треба вказати шлях до нашого додатку **health check path**.

![][image36]  
![][image37]
